#!/bin/sh
# Pre-commit hook to run goimports, gofmt, and golangci-lint

# Run goimports
echo "Running goimports..."
goimports -w *.go
if [ $? -ne 0 ]; then
    echo "goimports failed"
    exit 1
fi

# Run gofmt
echo "Running gofmt..."
gofmt -w -s *.go
if [ $? -ne 0 ]; then
    echo "gofmt failed"
    exit 1
fi

# Stage any formatting changes
git add -u

# Run golangci-lint (only fail on critical issues)
echo "Running golangci-lint..."
# Check for critical issues only (errcheck, staticcheck, gocritic, etc.)
# Ignore cognitive complexity and unused warnings which are less critical
output=$(golangci-lint run --timeout 5m 2>&1)
critical_issues=$(echo "$output" | grep -E "(errcheck|staticcheck|gosec|gocritic|ineffassign|misspell)" | grep -v "cognitive complexity" || true)

if [ ! -z "$critical_issues" ]; then
    echo "Critical linting issues found:"
    echo "$critical_issues"
    echo ""
    echo "Please fix the critical linting issues before committing"
    exit 1
fi

# Show all issues for awareness but don't fail
if [ ! -z "$output" ]; then
    echo "Non-critical linting issues (commit will proceed):"
    echo "$output" | grep -E "(gocognit|unused)" || true
fi

echo "Pre-commit checks passed!"